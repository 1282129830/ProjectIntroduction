#### 培训课程搜索

###### 使用原因

1.课程数据量大，如果直接从数据库查的话查询效率低。

2.搜索功能的使用会很频繁，直接从数据库查会增加数据库的访问压力。

###### 解决方案

所以搜索用到了全文检索技术，我们使用的是Elastic Search，使用时通过spring的框架spring data es操作es。为了满足中文分词效果使用了ik分词器。

###### 使用步骤

首先安装es。然后构建索引库索引结构。再将数据库中的数据导入到索引库中，之后在商品上下架操作时自动将商品数据同步到索引库中。

###### 关键字搜索

将页面提交的关键字提交给后台，再使用spring data es 提供的模板类**ES Tempalte**完成搜索。其中对商品的搜索是基于构建的all字段（一个包含了所有搜索字段的聚合字段）完成的匹配询。All字段中包含了课程的名称+课程分类+课程培训周期。

###### 过滤条件查询

前提：数据有一个字段专门用于标识，这个规格参数是否用于搜索

关键字生成搜索结果后还提供了过滤条件的添加，过滤条件的生成是根据搜索结果动态展示的，因为不同的商品因为分类的不同对应的参数也不同，过滤条件是在关键字搜索的结果集中，通过聚合查询获取过滤查询条件。过滤条件包含分类，品牌，以及商品的规格参数。其中规格名称和规格值都是动态变化的。规格参数的展示是在用户点击某一个分类条件时，查询该分类对应用于搜索的规格名称以及规格值。在关键字搜索的基础上再点击过滤条件进行进一步的筛选商品数据。

###### 课程上下架时同步索引库实现模块解耦合

课程在进行上下架操作之后需要对课程的展示数据和课程搜索的索引库进行修改，有两种方案都能实现三个微服务的数据同步，方案一就是在商品微服务完成上下架商品业务后，加入修改索引库和商品展示的静态页，方案二是搜索服务和静态页服务对外提供操作索引库和静态页的接口，课程微服务在商品上下架后调用接口。但是这两种方案有一个严重的问题就是代码的耦合性太高，违背了微服务的独立原则，违背了开闭原则。所以我用到了消息队列。选用的MQ是Rabbit MQ，当课程微服务做了上下架操作后，无需操作索引库和静态页面，只需要发送一条消息，也不用关心消息被谁接受了，而搜索服务和静态页服务接受消息，分别处理索引库和静态页面。而以后如果有其他微服务需要依赖商品微服务的数据是，同样监听消息即可，商品微服务无需更改代码，并实现了模块解耦合。

